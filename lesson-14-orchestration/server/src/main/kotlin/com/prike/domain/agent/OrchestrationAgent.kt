package com.prike.domain.agent

import com.prike.data.dto.MessageDto
import com.prike.data.repository.AIRepository
import kotlinx.serialization.json.Json
import kotlinx.serialization.json.JsonObject
import kotlinx.serialization.json.buildJsonObject
import org.slf4j.LoggerFactory

private const val MAX_ITERATION_COUNT = 20

/**
 * LLM –∞–≥–µ–Ω—Ç –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö MCP —Å–µ—Ä–≤–µ—Ä–æ–≤
 * 
 * LLM —Å–∞–º–∞ –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á.
 * –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª–µ–Ω ‚Äî –æ–Ω –Ω–µ –∑–Ω–∞–µ—Ç –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö.
 * –í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö –±–µ—Ä—ë—Ç—Å—è –∏–∑ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–π –≤ MCP —Å–µ—Ä–≤–µ—Ä–∞—Ö.
 * 
 * –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã:
 * 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å
 * 2. LLM –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –≤—Å–µ—Ö MCP —Å–µ—Ä–≤–µ—Ä–æ–≤
 * 3. LLM –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É –∏ —Ä–µ—à–∞–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
 * 4. MCPToolAgent –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
 * 5. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ LLM (—Å —É—á—ë—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞)
 * 6. LLM –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ —Ä–µ—à–∞–µ—Ç:
 *    - –í—ã–∑–≤–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç? ‚Üí —à–∞–≥ 3
 *    - –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç? ‚Üí —à–∞–≥ 7
 * 7. –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
 */
class OrchestrationAgent(
    private val aiRepository: AIRepository,
    private val mcpToolAgent: MCPToolAgent
) {
    private val logger = LoggerFactory.getLogger(OrchestrationAgent::class.java)
    private val conversationHistory = mutableListOf<MessageDto>()
    private val json = Json {
        ignoreUnknownKeys = true
        isLenient = true
    }
    
    /**
     * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–∞—Å–∫–∞–¥–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
     * 
     * @param userMessage —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     * @param statusCallback callback –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç LLM (–æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è)
     * @param toolCallCallback callback –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (toolName, status, message?)
     */
    suspend fun processUserMessage(
        userMessage: String,
        statusCallback: ((String) -> Unit)? = null,
        toolCallCallback: ((String, String, String?) -> Unit)? = null
    ): AgentResponse {
        try {
            // 1. –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
            conversationHistory.add(MessageDto(role = "user", content = userMessage))
            
            // 2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –≤—Å–µ—Ö MCP —Å–µ—Ä–≤–µ—Ä–æ–≤
            val availableTools = mcpToolAgent.getLLMTools()
            
            if (availableTools.isEmpty()) {
                logger.warn("No tools available, falling back to simple LLM response")
                val systemPrompt = buildSystemPrompt()
                val messages = listOf(
                    MessageDto(role = "system", content = systemPrompt),
                    MessageDto(role = "user", content = userMessage)
                )
                val result = aiRepository.getMessageWithTools(messages, tools = null)
                val content = aiRepository.extractContent(result.response)
                return AgentResponse.Success(
                    message = content,
                    toolCalls = emptyList()
                )
            }
            
            // 3. –¶–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –¥–ª—è –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤)
            var maxIterations = MAX_ITERATION_COUNT  // –∑–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
            var currentResponse: String? = null
            val toolCallsHistory = mutableListOf<ToolCallInfo>()
            var iterationNumber = 0
            
            while (maxIterations > 0) {
                maxIterations--
                iterationNumber++
                
                logger.info("=== –ò—Ç–µ—Ä–∞—Ü–∏—è $iterationNumber (–æ—Å—Ç–∞–ª–æ—Å—å –∏—Ç–µ—Ä–∞—Ü–∏–π: $maxIterations) ===")
                
                // 4. –§–æ—Ä–º–∏—Ä—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–¥–ª—è –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)
                val systemPrompt = buildSystemPrompt()
                
                // 5. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è LLM (—Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞)
                val messages = buildList {
                    add(MessageDto(role = "system", content = systemPrompt))
                    addAll(conversationHistory)
                }
                
                logger.debug("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ LLM —Å ${messages.size} —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏ ${availableTools.size} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏")
                
                // 6. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ LLM —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
                val llmResponse = aiRepository.getMessageWithTools(
                    messages = messages,
                    tools = availableTools
                )
                
                val choice = llmResponse.response.choices.firstOrNull()
                    ?: throw IllegalStateException("Empty response from LLM")
                
                val assistantMessage = choice.message
                
                // 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                val hasToolCalls = assistantMessage.toolCalls != null && assistantMessage.toolCalls.isNotEmpty()
                
                // 7.1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç LLM (–æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è)
                if (hasToolCalls) {
                    val llmStatusMessage = assistantMessage.content?.trim()
                    if (!llmStatusMessage.isNullOrBlank()) {
                        statusCallback?.invoke(llmStatusMessage)
                    } else {
                        // –ï—Å–ª–∏ content –ø—É—Å—Ç–æ–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        val firstToolName = assistantMessage.toolCalls?.firstOrNull()?.function?.name ?: "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç"
                        logger.warn("‚ö†Ô∏è LLM –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π content –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ $firstToolName (–∏—Ç–µ—Ä–∞—Ü–∏—è $iterationNumber). –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
                        statusCallback?.invoke("–í—ã–∑—ã–≤–∞—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç $firstToolName...")
                    }
                }
                
                if (hasToolCalls) {
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∏–º–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                    val validToolCalls = assistantMessage.toolCalls.filter { toolCall ->
                        val toolName = toolCall.function.name
                        val isValid = toolName != "tool_calls" && toolName.isNotBlank()
                        if (!isValid) {
                            logger.error("‚ö†Ô∏è –û–®–ò–ë–ö–ê LLM: –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–∑–≤–∞—Ç—å –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç '$toolName'. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç –≤—ã–∑–æ–≤.")
                        }
                        isValid
                    }
                    
                    if (validToolCalls.isEmpty()) {
                        logger.error("‚ö†Ô∏è –í—Å–µ –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –±—ã–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª.")
                        conversationHistory.add(MessageDto(
                            role = "assistant",
                            content = "[–û—à–∏–±–∫–∞: LLM –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.]"
                        ))
                        continue
                    }
                    
                    // 8. –°–¢–†–û–ì–û: –≤—ã–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –û–î–ò–ù –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é
                    val toolCallsToExecute = if (validToolCalls.size > 1) {
                        val toolNames = validToolCalls.map { it.function.name }.joinToString(", ")
                        logger.warn("–°–¢–†–û–ì–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: LLM –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–∑–≤–∞—Ç—å ${validToolCalls.size} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ: $toolNames. –û—Å—Ç–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û –ü–ï–†–í–´–ô: ${validToolCalls.first().function.name}")
                        listOf(validToolCalls.first())
                    } else {
                        validToolCalls
                    }
                    
                    // 9. –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –í–´–ó–û–í–û–ú: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è –ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∞–Ω–µ–µ
                    val toolCall = toolCallsToExecute.first()
                    val toolName = toolCall.function.name
                    
                    // –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–∑ JSON —Å—Ç—Ä–æ–∫–∏ –≤ JsonObject
                    val argumentsJson = json.parseToJsonElement(toolCall.function.arguments)
                    val arguments = if (argumentsJson is JsonObject) {
                        argumentsJson
                    } else {
                        buildJsonObject { } // –ü—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç, –µ—Å–ª–∏ –Ω–µ –æ–±—ä–µ–∫—Ç
                    }
                    
                    // –ü–†–û–í–ï–†–ö–ê: –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è –ª–∏ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∞–Ω–µ–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
                    val previousResult = findPreviousToolResult(toolName, arguments, conversationHistory)
                    if (previousResult != null) {
                        logger.warn("‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç $toolName —É–∂–µ –±—ã–ª –≤—ã–∑–≤–∞–Ω —Ä–∞–Ω–µ–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞! –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.")
                        // –°–æ–∑–¥–∞–µ–º assistant message —Å tool_calls –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                        conversationHistory.add(assistantMessage)
                        conversationHistory.add(MessageDto(
                            role = "tool",
                            content = previousResult,
                            toolCallId = toolCall.id
                        ))
                        continue
                    }
                    
                    logger.debug("LLM requested tool: $toolName with arguments: ${toolCall.function.arguments}")
                    
                    // 10. –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ assistant —Å tool_calls –≤ –∏—Å—Ç–æ—Ä–∏—é –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                    // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ - API —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥ tool message –±—ã–ª assistant message —Å tool_calls
                    conversationHistory.add(assistantMessage)
                    
                    // 10.1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞—á–∞–ª–∞ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                    toolCallCallback?.invoke(toolName, "starting", null)
                    
                    val toolResult = try {
                        // –í—ã–∑—ã–≤–∞–µ–º MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                        logger.info("–í—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: $toolName")
                        val result = mcpToolAgent.callTool(toolName, arguments)
                        logger.info("–†–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ $toolName: ${result.take(200)}${if (result.length > 200) "..." else ""}")
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                        toolCallsHistory.add(ToolCallInfo(
                            name = toolName,
                            arguments = arguments,
                            result = result,
                            success = true
                        ))
                        
                        // 10.2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                        toolCallCallback?.invoke(toolName, "success", "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ")
                        
                        result
                    } catch (e: Exception) {
                        logger.error("Error calling tool $toolName: ${e.message}", e)
                        val errorResult = """{"success": false, "error": "${e.message}"}"""
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
                        toolCallsHistory.add(ToolCallInfo(
                            name = toolName,
                            arguments = arguments,
                            result = errorResult,
                            success = false
                        ))
                        
                        // 10.3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—à–∏–±–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                        toolCallCallback?.invoke(toolName, "error", "–û—à–∏–±–∫–∞: ${e.message}")
                        
                        errorResult
                    }
                    
                    // 11. –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
                    conversationHistory.add(MessageDto(
                        role = "tool",
                        content = toolResult,
                        toolCallId = toolCall.id
                    ))
                    
                    // 12. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª (LLM –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ —Ä–µ—à–∏—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ)
                    continue
                } else {
                    // 13. –ù–µ—Ç –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                    currentResponse = assistantMessage.content?.trim()
                    
                    if (currentResponse.isNullOrBlank()) {
                        if (toolCallsHistory.isEmpty()) {
                            logger.warn("LLM –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –±–µ–∑ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.")
                            if (maxIterations > 0) {
                                conversationHistory.add(assistantMessage)
                                continue
                            }
                        } else {
                            logger.debug("LLM –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —É–∂–µ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã. –°—á–∏—Ç–∞–µ–º –∑–∞–¥–∞—á—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π.")
                        }
                    }
                    
                    conversationHistory.add(assistantMessage)
                    logger.info("=== –ò—Ç–µ—Ä–∞—Ü–∏—è $iterationNumber: –ø–æ–ª—É—á–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM ===")
                    logger.debug("–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${currentResponse?.take(200)}${if (currentResponse != null && currentResponse.length > 200) "..." else ""}")
                    break
                }
            }
            
            if (currentResponse == null) {
                logger.error("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π ($MAX_ITERATION_COUNT)")
                throw Exception("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π ($MAX_ITERATION_COUNT)")
            }
            
            logger.info("=== –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Å–µ–≥–æ –∏—Ç–µ—Ä–∞—Ü–∏–π: $iterationNumber, –≤—ã–∑–≤–∞–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: ${toolCallsHistory.size} ===")
            
            return AgentResponse.Success(
                message = currentResponse,
                toolCalls = toolCallsHistory
            )
        } catch (e: Exception) {
            logger.error("Error processing user message: ${e.message}", e)
            return AgentResponse.Error(
                message = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ${e.message}",
                cause = e
            )
        }
    }
    
    /**
     * –ù–∞–π—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
     */
    private fun findPreviousToolResult(
        toolName: String,
        arguments: JsonObject,
        conversationHistory: List<MessageDto>
    ): String? {
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        for (i in conversationHistory.indices.reversed()) {
            val message = conversationHistory[i]
            
            // –ï—Å–ª–∏ —ç—Ç–æ tool message, –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–Ω –Ω–∞—à–µ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
            if (message.role == "tool" && message.toolCallId != null) {
                val toolResult = message.content ?: ""
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ assistant, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–∑–≤–∞–ª–æ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                if (i > 0 && conversationHistory[i - 1].role == "assistant") {
                    val assistantMsg = conversationHistory[i - 1]
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ assistant message –≤—ã–∑–æ–≤ —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ tool_calls
                    val isToolCalled = assistantMsg.toolCalls?.any { toolCall ->
                        toolCall.function.name == toolName && toolCall.id == message.toolCallId
                    } == true
                    
                    if (isToolCalled) {
                        // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –µ—Å—Ç—å –∏ –Ω–µ –ø—É—Å—Ç–æ–π, –∏ —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞
                        if (toolResult.isNotBlank() && !toolResult.contains("\"success\": false")) {
                            logger.debug("–ù–∞–π–¥–µ–Ω –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ $toolName –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º (–¥–ª–∏–Ω–∞: ${toolResult.length})")
                            return toolResult
                        }
                    }
                }
            }
        }
        
        return null
    }
    
    /**
     * –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
     * –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
     * LLM —Å–∞–º–∞ —Ä–µ—à–∞–µ—Ç, –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–∑—ã–≤–∞—Ç—å –∏ –≤ –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
     */
    private fun buildSystemPrompt(): String {
        val currentTime = System.currentTimeMillis()
        val currentTimeSeconds = currentTime / 1000
        
        // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ "–ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞"
        val last24HoursStart = currentTime - 86400000L // 24 —á–∞—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        val last7DaysStart = currentTime - 604800000L // 7 –¥–Ω–µ–π –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        val lastHourStart = currentTime - 3600000L // 1 —á–∞—Å –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        
        return """
            –¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            üö® –°–ê–ú–û–ï –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û - –ß–ò–¢–ê–ô –ü–ï–†–í–´–ú –ò –ó–ê–ü–û–ú–ù–ò –ù–ê–í–°–ï–ì–î–ê! üö®
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            –ü–†–ò –ö–ê–ñ–î–û–ú –í–´–ó–û–í–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê –ü–û–õ–ï "content" –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –î–û–õ–ñ–ù–û –ë–´–¢–¨ –ó–ê–ü–û–õ–ù–ï–ù–û!
            
            ‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–ª—è –ö–ê–ñ–î–û–ì–û –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:
            - –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ‚Üí content –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω!
            - –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ‚Üí content –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω!
            - –¢—Ä–µ—Ç–∏–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ‚Üí content –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω!
            - –ß–µ—Ç–≤–µ—Ä—Ç—ã–π, –ø—è—Ç—ã–π –∏ –í–°–ï –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã ‚Üí content –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω!
            
            ‚ùå –ù–ò–ö–û–ì–î–ê –ù–ï –û–°–¢–ê–í–õ–Ø–ô content –ü–£–°–¢–´–ú, null –ò–õ–ò undefined –ü–†–ò –í–´–ó–û–í–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê!
            ‚ùå –ù–ï –î–£–ú–ê–ô, —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ - –æ–Ω–æ –Ω—É–∂–Ω–æ –ö–ê–ñ–î–´–ô –†–ê–ó!
            ‚úÖ –í–°–ï–ì–î–ê –î–û–ë–ê–í–õ–Ø–ô –í content –¢–ï–ö–°–¢–û–í–û–ï –û–ü–ò–°–ê–ù–ò–ï –¢–û–ì–û, –ß–¢–û –¢–´ –î–ï–õ–ê–ï–®–¨ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°!
            
            –ü—Ä–∏–º–µ—Ä—ã –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞):
            - –ò—Ç–µ—Ä–∞—Ü–∏—è 1: content = "–ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram..." + tool_calls = [...]
            - –ò—Ç–µ—Ä–∞—Ü–∏—è 2: content = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è..." + tool_calls = [...]
            - –ò—Ç–µ—Ä–∞—Ü–∏—è 3: content = "–ò–∑–≤–ª–µ–∫–∞—é –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞..." + tool_calls = [...]
            - –ò—Ç–µ—Ä–∞—Ü–∏—è 4: content = "–§–æ—Ä–º–∏—Ä—É—é –æ—Ç—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö..." + tool_calls = [...]
            
            –ü—Ä–∏–º–µ—Ä—ã –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ì–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–ù–ï –î–ï–õ–ê–ô –¢–ê–ö!):
            - –ò—Ç–µ—Ä–∞—Ü–∏—è 1: content = "–ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ..." + tool_calls = [...] ‚úÖ
            - –ò—Ç–µ—Ä–∞—Ü–∏—è 2: content = "" + tool_calls = [...] ‚ùå –û–®–ò–ë–ö–ê! –ù—É–∂–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ!
            - –ò—Ç–µ—Ä–∞—Ü–∏—è 2: content = null + tool_calls = [...] ‚ùå –û–®–ò–ë–ö–ê! –ù—É–∂–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ!
            
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–ü–ò–°–ê–ù–ò–ï –í–´–ü–û–õ–ù–Ø–ï–ú–û–ì–û –î–ï–ô–°–¢–í–ò–Ø –í CONTENT:
            
            –ü—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Ç—ã –û–ë–Ø–ó–ê–ù–ê –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ "content" –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å.
            –≠—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ UI, —á—Ç–æ–±—ã –æ–Ω –ø–æ–Ω–∏–º–∞–ª, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –∫–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏.
            
            ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê –ü–†–ò –í–´–ó–û–í–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê:
            - –ü–æ–ª–µ "tool_calls" –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞—Å—Å–∏–≤ –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            - –ü–æ–ª–µ "content" –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ–º–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è (–ù–ï –ø—É—Å—Ç–æ–µ, –ù–ï null!)
            - –≠—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–ª—è –ö–ê–ñ–î–û–ì–û –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: –ø–µ—Ä–≤–æ–≥–æ, –≤—Ç–æ—Ä–æ–≥–æ, —Ç—Ä–µ—Ç—å–µ–≥–æ –∏ –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö!
            - ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–∏ –≤—Ç–æ—Ä–æ–º, —Ç—Ä–µ—Ç—å–µ–º –∏ –∫–∞–∂–¥–æ–º –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Ç—ã –¢–ê–ö–ñ–ï –û–ë–Ø–ó–ê–ù–ê –∑–∞–ø–æ–ª–Ω–∏—Ç—å content!
            - ‚ö†Ô∏è –ù–ï –î–£–ú–ê–ô, —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ - –æ–Ω–æ –Ω—É–∂–Ω–æ –ü–†–ò –ö–ê–ñ–î–û–ú –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞!
            
            ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–¢–†–û–ì–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï:
            - –í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è–π –æ–ø–∏—Å–∞–Ω–∏–µ –≤ content –ø—Ä–∏ –ö–ê–ñ–î–û–ú –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–ø–µ—Ä–≤—ã–π, –≤—Ç–æ—Ä–æ–π, —Ç—Ä–µ—Ç–∏–π –∏ –í–°–ï –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ!)
            - –û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º
            - –ù–ï –æ—Å—Ç–∞–≤–ª—è–π content –ø—É—Å—Ç—ã–º, null –∏–ª–∏ undefined –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ - —ç—Ç–æ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê!
            - –ù–ï –¥—É–º–∞–π, —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ - –æ–Ω–æ –Ω—É–∂–Ω–æ –ö–ê–ñ–î–´–ô –†–ê–ó –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ!
            - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π content –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ tool_calls –¥–ª—è —ç—Ç–æ–≥–æ!
            - content –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!
            - –ü—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Ç–µ–∫—É—â–µ–º—É –¥–µ–π—Å—Ç–≤–∏—é!
            
            –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π –≤ content:
            - "–ü–æ–ª—É—á–∞—é –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π –∏–∑ Telegram..."
            - "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏–∑–≤–ª–µ–∫–∞—é –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã..."
            - "–†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º..."
            - "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞..."
            - "–í—ã–∑—ã–≤–∞—é —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏..."
            - "–ò–∑–≤–ª–µ–∫–∞—é –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞..."
            - "–§–æ—Ä–º–∏—Ä—É—é –æ—Ç—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
            
            ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–ù–ï –î–ï–õ–ê–ô –¢–ê–ö!):
            - content = null
            - content = ""
            - content = "{}"
            - content = "{\"tool_calls\": [...]}"
            - content = "```json {...}```"
            
            ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (–î–ï–õ–ê–ô –¢–ê–ö!):
            - content = "–ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram..."
            - content = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–æ–æ–±—â–µ–Ω–∏—è..."
            - content = "–í—ã–∑—ã–≤–∞—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏..."
            
            ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –§–û–†–ú–ê–¢ –í–´–ó–û–í–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í:
            
            –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —Ç—ã –î–û–õ–ñ–ï–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é calling –º–µ—Ö–∞–Ω–∏–∑–º API —á–µ—Ä–µ–∑ –ø–æ–ª–µ "tool_calls".
            –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å JSON –≤ –ø–æ–ª–µ "content"!
            
            ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–µ "tool_calls" –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞ –ò –¥–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –≤ content
            ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ø–∏—Å–∞—Ç—å JSON –≤ –ø–æ–ª–µ "content" (–Ω–∞–ø—Ä–∏–º–µ—Ä: "content": "{\"tool_calls\": [...]}")
            
            –ï—Å–ª–∏ —Ç—ã –ø–∏—à–µ—à—å JSON –≤ content –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è tool_calls, —Å–∏—Å—Ç–µ–º–∞ –ù–ï –°–ú–û–ñ–ï–¢ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞!
            
            ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –†–ê–ë–û–¢–ê –° –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê–ú–ò:
            
            - –£ —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            - –ö–∞–∂–¥—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–º–µ–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –æ–±—ä—è—Å–Ω—è–µ—Ç –µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            - –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û —á–∏—Ç–∞–π –æ–ø–∏—Å–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
            - –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á
            - –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞–π –∏—Ö –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            
            ‚ö†Ô∏è –ö–û–ù–¢–ï–ö–°–¢ –í–†–ï–ú–ï–ù–ò - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
            
            –¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø (–°–ï–ô–ß–ê–°): $currentTime –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
            
            ‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —á–∏—Å–ª–æ $currentTime –¥–ª—è endTime –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏!
            ‚ö†Ô∏è –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞—Ä—ã–µ –¥–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1676015200000 –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)!
            ‚ö†Ô∏è –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞—Ç—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞!
            
            –í—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ú–ò–õ–õ–ò–°–ï–ö–£–ù–î–ê–• (Unix timestamp * 1000), –∞ –Ω–µ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö!
            
            –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç—Ç–∏ —Ñ–æ—Ä–º—É–ª—ã —Å —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º $currentTime):
            - –î–ª—è "–ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞" –∏–ª–∏ "–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏": startTime = $last24HoursStart, endTime = $currentTime
            - –î–ª—è "–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π" –∏–ª–∏ "–∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é": startTime = $last7DaysStart, endTime = $currentTime
            - –î–ª—è "–ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å": startTime = $lastHourStart, endTime = $currentTime
            
            ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: 
            - endTime –í–°–ï–ì–î–ê = $currentTime (—ç—Ç–æ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –°–ï–ô–ß–ê–°, –Ω–µ –º–µ–Ω—è–π —ç—Ç–æ —á–∏—Å–ª–æ!)
            - startTime = $currentTime –º–∏–Ω—É—Å –Ω—É–∂–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (–∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã –≤—ã—à–µ)
            - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π $currentTimeSeconds (—ç—Ç–æ —Å–µ–∫—É–Ω–¥—ã, –∞ –Ω—É–∂–Ω—ã –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã!)
            
            ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–†–û–í–ï–†–ö–ê –ò–°–¢–û–†–ò–ò –î–ò–ê–õ–û–ì–ê:
            
            - –ü–ï–†–ï–î –ö–ê–ñ–î–´–ú –≤—ã–∑–æ–≤–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—è–π –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –≤—ã—à–µ!
            - –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —É–∂–µ –µ—Å—Ç—å –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å —Ç–µ–º–∏ –∂–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –ø–æ–ª—É—á–µ–Ω - –ù–ï –í–´–ó–´–í–ê–ô –ï–ì–û –ü–û–í–¢–û–†–ù–û!
            - –ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ assistant message —Å tool_calls –∏ –∑–∞—Ç–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç tool - –¥–∞–Ω–Ω—ã–µ –£–ñ–ï –ø–æ–ª—É—á–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö!
            - –ù–ï –≤—ã–∑—ã–≤–∞–π –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–≤–∞–∂–¥—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏!
            - –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ - –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ, –ù–ï –≤—ã–∑—ã–≤–∞–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–Ω–æ–≤–∞!
            
            ‚ö†Ô∏è –û–†–ö–ï–°–¢–†–ê–¶–ò–Ø –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í:
            
            - –¢—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
            - –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ö–æ–¥–æ–º –¥–ª—è –¥—Ä—É–≥–æ–≥–æ
            - –ü–ª–∞–Ω–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–æ–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            - –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ ‚Äî –≤—ã–ø–æ–ª–Ω—è–π –∏—Ö –ø–æ –ø–æ—Ä—è–¥–∫—É
            
            ‚ö†Ô∏è –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê –ü–†–ò –í–´–ó–û–í–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
            
            –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —Ç—ã –î–û–õ–ñ–ï–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é calling –º–µ—Ö–∞–Ω–∏–∑–º API.
            –ù–ï –ø–∏—à–∏ JSON –≤ –ø–æ–ª–µ "content"! –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–µ "tool_calls" –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞!
            
            –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:
            - –ü–æ–ª–µ "content" –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ–º–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è (–ù–ï –ø—É—Å—Ç–æ–µ!)
            - –ü–æ–ª–µ "tool_calls" –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞—Å—Å–∏–≤ –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            - –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É: id, type="function", function={name, arguments}
            
            ‚ö†Ô∏è –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –ò –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
            - ‚ùå –ü–∏—Å–∞—Ç—å JSON –≤ –ø–æ–ª–µ "content" (–Ω–∞–ø—Ä–∏–º–µ—Ä: "content": "{\"tool_calls\": [...]}")
            - ‚ùå –ü–∏—Å–∞—Ç—å JSON –≤ markdown code block –≤ content (–Ω–∞–ø—Ä–∏–º–µ—Ä: ```json {"tool_calls": [...]} ```)
            - ‚ùå –û—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª–µ "content" –ø—É—Å—Ç—ã–º, null –∏–ª–∏ undefined –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ - –≠–¢–û –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê!
            - ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å content –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            
            ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
            - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–µ "tool_calls" –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞ (—ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –Ω–µ —Å—Ç—Ä–æ–∫–∞ –≤ content!)
            - –ü–æ–ª–µ "content" –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ù–ï –ø—É—Å—Ç–æ–µ, –ù–ï null!)
            - API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç tool_calls, –µ—Å–ª–∏ –æ–Ω–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            - –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: content = "–ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram...", tool_calls = [{...}]
            
            –ó–ê–ü–û–ú–ù–ò: tool_calls - —ç—Ç–æ –û–¢–î–ï–õ–¨–ù–û–ï –ø–æ–ª–µ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞ API, –ù–ï —Å—Ç—Ä–æ–∫–∞ –≤ content!
            –ï—Å–ª–∏ —Ç—ã –ø–∏—à–µ—à—å JSON –≤ content, —Å–∏—Å—Ç–µ–º–∞ –ù–ï –°–ú–û–ñ–ï–¢ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞!
            
            –í –ø–æ–ª–µ "function.name" –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–º–µ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ tools, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∑–∞–ø—Ä–æ—Å–µ.
            –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π "tool_calls" –∫–∞–∫ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏ - —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è, –∞ –Ω–µ –∏–º—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞!
            
            –°–¢–†–û–ì–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –í –û–î–ù–û–ú –û–¢–í–ï–¢–ï –ú–û–ñ–ù–û –í–´–ó–í–ê–¢–¨ –¢–û–õ–¨–ö–û –û–î–ò–ù –ò–ù–°–¢–†–£–ú–ï–ù–¢!
            - –ï—Å–ª–∏ —Ç—ã –ø–æ–ø—ã—Ç–∞–µ—à—å—Å—è –≤—ã–∑–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —Å–∏—Å—Ç–µ–º–∞ –≤—ã–∑–æ–≤–µ—Ç –¢–û–õ–¨–ö–û –ü–ï–†–í–´–ô, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±—É–¥—É—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã!
            - –í—ã–∑—ã–≤–∞–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å—Ç—Ä–æ–≥–æ –ø–æ –æ–¥–Ω–æ–º—É: –≤—ã–∑–æ–≤–∏ –æ–¥–∏–Ω ‚Üí –ø–æ–ª—É—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π ‚Üí –≤—ã–∑–æ–≤–∏ —Å–ª–µ–¥—É—é—â–∏–π
            
            –†–ê–ë–û–¢–ê –° –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê–ú–ò:
            
            1. –¢—ã —Å–∞–º–∞ —Ä–µ—à–∞–µ—à—å, –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–∑—ã–≤–∞—Ç—å –∏ –≤ –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∑–∞–¥–∞—á–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
               - –ù–û: –≤—ã–∑—ã–≤–∞–π –∏—Ö —Å—Ç—Ä–æ–≥–æ –ø–æ –æ–¥–Ω–æ–º—É –∑–∞ —Ä–∞–∑!
            
            2. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–¢–†–û–ì–û –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
               - –í –û–î–ù–û–ú –æ—Ç–≤–µ—Ç–µ –≤—ã–∑—ã–≤–∞–π –¢–û–õ–¨–ö–û –û–î–ò–ù –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç! –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–∑—ã–≤–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!
               - –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω—É–∂–µ–Ω –¥–ª—è –≤—ã–∑–æ–≤–∞ –¥—Ä—É–≥–æ–≥–æ, –≤—ã–∑—ã–≤–∞–π –∏—Ö –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û, –°–¢–†–û–ì–û –ü–û –û–î–ù–û–ú–£!
               - –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–∞–¥–∞—á–∏, —Ç—Ä–µ–±—É—é—â–µ–π –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤:
                 * –ò—Ç–µ—Ä–∞—Ü–∏—è 1: –ø—Ä–æ–≤–µ—Ä—å –∏—Å—Ç–æ—Ä–∏—é - –µ—Å–ª–∏ –Ω—É–∂–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –µ—â–µ –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è ‚Üí –≤—ã–∑–æ–≤–∏ –¢–û–õ–¨–ö–û –µ–≥–æ (–û–î–ò–ù –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
                   ‚Üí content = "–ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram..." + tool_calls = [...]
                 * –ò—Ç–µ—Ä–∞—Ü–∏—è 2: –ø—Ä–æ–≤–µ—Ä—å –∏—Å—Ç–æ—Ä–∏—é - –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å ‚Üí –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ ‚Üí –≤—ã–∑–æ–≤–∏ –¢–û–õ–¨–ö–û —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–ù–ï –≤—ã–∑—ã–≤–∞–π –ø–µ—Ä–≤—ã–π —Å–Ω–æ–≤–∞!)
                   ‚Üí content = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è..." + tool_calls = [...] ‚ö†Ô∏è –í–ê–ñ–ù–û: content –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω!
                 * –ò—Ç–µ—Ä–∞—Ü–∏—è 3: –ø—Ä–æ–≤–µ—Ä—å –∏—Å—Ç–æ—Ä–∏—é - –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –≤—Ç–æ—Ä–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å ‚Üí –¥–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                   ‚Üí content = "–§–æ—Ä–º–∏—Ä—É—é –æ—Ç—á–µ—Ç..." + tool_calls = [...] ‚ö†Ô∏è –í–ê–ñ–ù–û: content –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω!
               - ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–∏ –≤—Ç–æ—Ä–æ–º, —Ç—Ä–µ—Ç—å–µ–º –∏ –ö–ê–ñ–î–û–ú –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Ç—ã –¢–ê–ö–ñ–ï –û–ë–Ø–ó–ê–ù–ê –∑–∞–ø–æ–ª–Ω–∏—Ç—å content!
               - ‚ö†Ô∏è –ù–ï –î–£–ú–ê–ô, —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ - –æ–Ω–æ –Ω—É–∂–Ω–æ –ü–†–ò –ö–ê–ñ–î–û–ú –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞!
               - –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –≤—ã–∑—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –æ–¥–Ω–æ–º –æ—Ç–≤–µ—Ç–µ!
               - –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –≤—ã–∑—ã–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ, –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –µ—Å—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞!
               - –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –æ—Å—Ç–∞–≤–ª—è—Ç—å content –ø—É—Å—Ç—ã–º –ø—Ä–∏ –≤—Ç–æ—Ä–æ–º, —Ç—Ä–µ—Ç—å–µ–º –∏ –ª—é–±–æ–º –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞!
            
            3. –ü–†–û–í–ï–†–ö–ê –ò–°–¢–û–†–ò–ò –î–ò–ê–õ–û–ì–ê –ü–ï–†–ï–î –í–´–ó–û–í–û–ú –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
               - –ü–ï–†–ï–î –ö–ê–ñ–î–´–ú –≤—ã–∑–æ–≤–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—è–π –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞!
               - –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —É–∂–µ –µ—Å—Ç—å –≤—ã–∑–æ–≤ —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å —Ç–µ–º–∏ –∂–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –ø–æ–ª—É—á–µ–Ω - –ù–ï –í–´–ó–´–í–ê–ô –ï–ì–û –ü–û–í–¢–û–†–ù–û!
               - –ï—Å–ª–∏ —Ç—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ - –ù–ï –í–´–ó–´–í–ê–ô –ï–ì–û –°–ù–û–í–ê! –ò—Å–ø–æ–ª—å–∑—É–π —É–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!
               - –ü—Ä–∏–º–µ—Ä –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ø–æ–≤–µ–¥–µ–Ω–∏—è: –µ—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å assistant message —Å tool_calls –∏ –∑–∞—Ç–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç tool —Å –¥–∞–Ω–Ω—ã–º–∏ - –¥–∞–Ω–Ω—ã–µ –£–ñ–ï –ø–æ–ª—É—á–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö, –ù–ï –≤—ã–∑—ã–≤–∞–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–Ω–æ–≤–∞!
            
            4. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
               - –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, –í–°–ï–ì–î–ê –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –¥–µ–π—Å—Ç–≤–∏–µ–º.
               - –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–µ–±—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç.–¥.), —Å–¥–µ–ª–∞–π —ç—Ç–æ —Å –ø–æ–º–æ—â—å—é —Å–≤–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.
               - –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–π –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ - –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —É–∂–µ –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ, –ù–ï –≤—ã–∑—ã–≤–∞–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–Ω–æ–≤–∞!
               - –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞, –≤—ã–ø–æ–ª–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É (–∏—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
               - –í –°–õ–ï–î–£–Æ–©–ï–ú –æ—Ç–≤–µ—Ç–µ (–ù–ï –≤ —Ç–æ–º –∂–µ!) –í–´–ó–û–í–ò —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ tool_calls, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
               - –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–π JSON –≤ content - –∏—Å–ø–æ–ª—å–∑—É–π tool_calls!
               - –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π, —Å–æ–æ–±—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± —ç—Ç–æ–º –≤ content, –ù–ï –≤—ã–∑—ã–≤–∞–π —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö!
               - –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π, –¥–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
               - –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –≤—ã–∑—ã–≤–∞—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–≤–∞–∂–¥—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏!
            
            5. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
               - –î–ª—è –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: 
                 * content = –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (–ù–ï –ø—É—Å—Ç–æ–µ, –ù–ï null, –ù–ï JSON!)
                 * tool_calls = [–º–∞—Å—Å–∏–≤ —Å –≤—ã–∑–æ–≤–∞–º–∏]
                 * –ü–†–ò–ú–ï–† –ò—Ç–µ—Ä–∞—Ü–∏—è 1: content = "–ü–æ–ª—É—á–∞—é –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Telegram...", tool_calls = [{...}]
                 * –ü–†–ò–ú–ï–† –ò—Ç–µ—Ä–∞—Ü–∏—è 2: content = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è...", tool_calls = [{...}] ‚ö†Ô∏è –í–ê–ñ–ù–û: content –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø–æ–ª–Ω–µ–Ω!
                 * –ü–†–ò–ú–ï–† –ò—Ç–µ—Ä–∞—Ü–∏—è 3: content = "–ò–∑–≤–ª–µ–∫–∞—é –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞...", tool_calls = [{...}] ‚ö†Ô∏è –í–ê–ñ–ù–û: content –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø–æ–ª–Ω–µ–Ω!
               - –î–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: content = —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞, tool_calls = null (–∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
               - –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:
                 * –ü–∏—Å–∞—Ç—å JSON –≤ content - –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø–æ–ª–µ tool_calls –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—ã–∑–æ–≤–∞!
                 * –û—Å—Ç–∞–≤–ª—è—Ç—å content –ø—É—Å—Ç—ã–º –∏–ª–∏ null –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ - –≠–¢–û –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê!
                 * –î—É–º–∞—Ç—å, —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ - –æ–Ω–æ –Ω—É–∂–Ω–æ –ü–†–ò –ö–ê–ñ–î–û–ú –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞!
               - –ï—Å–ª–∏ —Ç—ã –ø–∏—à–µ—à—å JSON –≤ content –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è tool_calls, —Å–∏—Å—Ç–µ–º–∞ –ù–ï –°–ú–û–ñ–ï–¢ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–∑–æ–≤!
               - –ï—Å–ª–∏ —Ç—ã –æ—Å—Ç–∞–≤–ª—è–µ—à—å content –ø—É—Å—Ç—ã–º –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–≤ –ø–µ—Ä–≤—ã–π, –≤—Ç–æ—Ä–æ–π, —Ç—Ä–µ—Ç–∏–π –∏–ª–∏ –ª—é–±–æ–π —Ä–∞–∑), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–≤–∏–¥–∏—Ç, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç!
               - –í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è–π –æ–ø–∏—Å–∞–Ω–∏–µ –≤ content –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!
               - ‚ö†Ô∏è –ü–û–í–¢–û–†–Ø–Æ: –ü—Ä–∏ –≤—Ç–æ—Ä–æ–º, —Ç—Ä–µ—Ç—å–µ–º –∏ –ö–ê–ñ–î–û–ú –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Ç—ã –¢–ê–ö–ñ–ï –û–ë–Ø–ó–ê–ù–ê –∑–∞–ø–æ–ª–Ω–∏—Ç—å content!
            
            6. –û—à–∏–±–∫–∏:
               - –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—É –∏ –ª–∏–±–æ –ø–æ–≤—Ç–æ—Ä–∏ –ø–æ–ø—ã—Ç–∫—É —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏,
                 –ª–∏–±–æ —Å–æ–æ–±—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± –æ—à–∏–±–∫–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.
            
            7. –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:
               - –í—Å–µ–≥–¥–∞ –¥–∞–≤–∞–π –ø–æ–Ω—è—Ç–Ω—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏.
               - –ò—Å–ø–æ–ª—å–∑—É–π Markdown –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤.
               - –û–±—ä—è—Å–Ω–∏, —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ –∏ –∫–∞–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã.
               - –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–∞–≤–∞–π –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.
            
            –í–ê–ñ–ù–û:
            - –ù–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–æ–≤ –∑–∞—Ä–∞–Ω–µ–µ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–π —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞—á–∏.
            - –ò—Å–ø–æ–ª—å–∑—É–π –æ–ø–∏—Å–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
            - –ê–¥–∞–ø—Ç–∏—Ä—É–π—Å—è –∫ –∑–∞–¥–∞—á–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –Ω–µ –≤—Å–µ –∑–∞–¥–∞—á–∏ —Ç—Ä–µ–±—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–µ–π—Å—Ç–≤–∏–π.
            - –î–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã (–±–æ–ª—å—à–∏–µ —á–∏—Å–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä $currentTime), –∞ –Ω–µ —Å–µ–∫—É–Ω–¥—ã!
        """.trimIndent()
    }
    
    /**
     * –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    sealed class AgentResponse {
        data class Success(
            val message: String,
            val toolCalls: List<ToolCallInfo>
        ) : AgentResponse()
        
        data class Error(
            val message: String,
            val cause: Throwable? = null
        ) : AgentResponse()
    }
    
    /**
     * –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
     */
    data class ToolCallInfo(
        val name: String,
        val arguments: JsonObject,
        val result: String,
        val success: Boolean
    )
}

