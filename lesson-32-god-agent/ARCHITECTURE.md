# Архитектура God Agent

## Обзор

God Agent построен на модульной архитектуре, где каждый компонент может быть включен или выключен через конфигурацию. Основные компоненты:

1. **God Agent Service** - главный оркестратор
2. **MCP Router** - управление MCP серверами
3. **Knowledge Base Service** - RAG система
4. **Request Router** - роутинг запросов
5. **User Profile Service** - персонализация

## Архитектурные слои

### Presentation Layer
- **Controllers**: REST API endpoints
- **DTOs**: Data Transfer Objects для API

### Domain Layer
- **Services**: Бизнес-логика
- **Models**: Доменные модели
- **Interfaces**: Контракты для сервисов

### Data Layer
- **Repositories**: Доступ к данным
- **Clients**: Внешние API клиенты
- **Database**: SQLite через Exposed

## Поток обработки запроса

```
1. Пользователь отправляет запрос
   ↓
2. ChatController получает запрос
   ↓
3. GodAgentService.processUserRequest()
   ↓
4. RequestRouterService.routeRequest()
   - Определяет тип запроса (MCP/RAG/Analytics/Direct)
   ↓
5. Выполнение действий:
   - MCP: MCPRouterService.executeTool()
   - RAG: KnowledgeBaseService.searchInCategory()
   - Analytics: Analytics MCP server
   ↓
6. Построение персонализированного промпта
   ↓
7. Генерация ответа через KoogAgentService
   ↓
8. Форматирование ответа
   ↓
9. Сохранение в историю
   ↓
10. Возврат ответа пользователю
```

## Компоненты

### God Agent Service

Главный сервис, объединяющий все компоненты. Отвечает за:
- Координацию работы всех сервисов
- Построение промптов с учетом контекста
- Извлечение источников для цитирования

### MCP Router Service

Управляет подключением и использованием MCP серверов:
- Загрузка конфигурации из YAML
- Подключение/отключение клиентов
- Выполнение инструментов
- Получение списка доступных инструментов

### Knowledge Base Service

RAG система для поиска в базе знаний:
- Индексация документов по категориям
- Генерация эмбеддингов через Ollama
- Поиск по косинусному сходству
- Управление чанками документов

### Request Router Service

Определяет, какие компоненты использовать для запроса:
- Анализ запроса пользователя
- Сопоставление с доступными инструментами
- Принятие решения о роутинге
- Извлечение параметров из запроса

### User Profile Service

Персонализация ответов:
- Управление профилями пользователей
- Адаптация стиля общения
- Учет предпочтений и контекста

## База данных

### Таблицы

- `chat_sessions` - сессии чата
- `chat_messages` - сообщения в чате
- `user_profiles` - профили пользователей
- `knowledge_base_chunks` - чанки документов для RAG
- `interaction_history` - история взаимодействий

## Конфигурация

Конфигурация разделена на несколько файлов:
- `config/server.yaml` - основная конфигурация
- `config/mcp-servers.yaml` - конфигурация MCP серверов
- `.env` - переменные окружения

## Расширяемость

### Добавление нового MCP сервера

1. Создать MCP сервер в `mcp-servers/`
2. Реализовать `MCPClientInterface`
3. Добавить конфигурацию в `mcp-servers.yaml`
4. Зарегистрировать клиент в `Main.kt`

### Добавление новой категории

1. Добавить категорию в `DocumentCategory` enum
2. Создать директорию в `knowledge-base/`
3. Обновить UI для отображения категории

### Добавление нового типа роутинга

1. Добавить действие в `RoutingAction` enum
2. Реализовать логику в `RequestRouterService`
3. Добавить обработку в `GodAgentService`

## Безопасность

- Контроль доступа через конфигурацию
- Валидация входных данных
- Обработка ошибок
- Логирование действий

## Производительность

- Кэширование конфигурации
- Асинхронная обработка запросов
- Оптимизация запросов к БД
- Ленивая загрузка компонентов

